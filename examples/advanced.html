<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrustQuery - Interactive Textarea Demo</title>
  <link rel="icon" type="image/svg+xml" href="./assets/trustquery-logo.svg">
  <link rel="stylesheet" href="./demo.css">
  <link rel="stylesheet" href="./modal.css">
</head>
<body>

  <header style="display: flex; align-items: center;">
    <div id="logo-container" style="display: flex; align-items: center; gap: 12px;">
      <img src="./assets/trustquery-logo.svg" alt="TrustQuery Logo" style="height: 32px; width: auto;">
      <span style="font-weight: bold; font-size: 20px;">TrustQuery</span>
    </div>
    <button id="help-button" class="help-button" title="Open Help">
      <span class="material-icons-outlined">help_outline</span>
    </button>
  </header>

  <div id="chat-messages" class="chat-messages">
    <!-- Chat messages will appear here -->
  </div>

  <div id="chat-input-wrapper" class="chat-input-wrapper">
    <div id="chat-attachments-container" class="chat-attachments-container">
      <!-- Attachments will appear here -->
    </div>

    <div class="chat-input-content">
      <div id="chat-input-container" class="chat-input-container">
        <textarea id="demo-textarea" placeholder="Type your message... Try @analytics, @client, or temporal words like 'yesterday'" rows="1"></textarea>
      </div>

      <div class="chat-actions-row">
        <div id="chat-input-submit" class="chat-input-submit">
          <button id="submit-button" class="submit-button" title="Send message">
            <span class="material-icons-outlined">send</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import TrustQuery from '../dist/trustquery.js';
    import HelpModalManager from './HelpModalManager.js';

    console.log('[Demo] Initializing TrustQuery...');

    // Initialize Help Modal Manager
    const helpModal = new HelpModalManager(null); // Pass null initially, update after editor loads

    // Initialize TrustQuery
    const editor = TrustQuery.init('demo-textarea', {
      commandMapUrl: './tql-triggers.json',
      autoLoadCommandMap: true,
      bubbleDelay: 300,

      onWordHover: (matchData) => {
        const messageState = matchData.intent?.handler?.['message-state'] || 'unknown';
        helpModal.logEvent(`Hovered: "${matchData.text}" (${messageState})`);
      },

      onWordClick: (matchData) => {
        const messageState = matchData.intent?.handler?.['message-state'] || 'unknown';
        helpModal.logEvent(`Clicked: "${matchData.text}" (${messageState})`);
        if (matchData.selectedOption) {
          const label = typeof matchData.selectedOption === 'string'
            ? matchData.selectedOption
            : matchData.selectedOption.label;
          helpModal.logEvent(`  â†’ Selected: ${label}`);
        }
      }
    });

    // Update help modal with editor reference
    helpModal.editor = editor;

    // Store globally for debugging under trustquery namespace
    window.trustquery = window.trustquery || {};
    window.trustquery.editor = editor;
    window.trustquery.helpModal = helpModal;

    // Setup help button
    document.getElementById('help-button').addEventListener('click', () => {
      helpModal.show();
    });

    // Log initialization after trigger map loads
    setTimeout(() => {
      if (editor && editor.commandMap) {
        // Count triggers from tql-triggers format
        let triggerCount = 0;
        if (editor.commandMap['tql-triggers']) {
          const triggers = editor.commandMap['tql-triggers'];
          Object.keys(triggers).forEach(state => {
            if (!state.startsWith('$') && Array.isArray(triggers[state])) {
              triggerCount += triggers[state].length;
            }
          });
        }

        helpModal.logEvent(`TrustQuery initialized with ${triggerCount} triggers`);
        // Modal content will be populated when user opens the modal
      } else {
        helpModal.logEvent('ERROR: Trigger map failed to load');
      }
    }, 1000);

    console.log('[Demo] TrustQuery initialized:', editor);

    // Auto-grow textarea functionality
    const textarea = document.getElementById('demo-textarea');
    const chatInputWrapper = document.getElementById('chat-input-wrapper');
    const attachmentsContainer = document.getElementById('chat-attachments-container');

    function autoGrowTextarea() {
      // Reset height to calculate new height
      textarea.style.height = 'auto';

      // Calculate new height (max 300px)
      const newHeight = Math.min(textarea.scrollHeight, 300);
      textarea.style.height = newHeight + 'px';
    }

    // Listen for input changes
    textarea.addEventListener('input', autoGrowTextarea);

    // Listen for keyboard events (for line breaks)
    textarea.addEventListener('keydown', (e) => {
      // Trigger resize after Enter key
      if (e.key === 'Enter' && !e.shiftKey) {
        setTimeout(autoGrowTextarea, 0);
      }
    });

    // Initial size
    autoGrowTextarea();

    // Demo: Toggle attachments (for testing)
    window.trustquery.toggleAttachment = () => {
      attachmentsContainer.classList.toggle('has-attachments');
      if (attachmentsContainer.classList.contains('has-attachments')) {
        attachmentsContainer.innerHTML = '<div style="background: #e2e8f0; padding: 8px 12px; border-radius: 6px; font-size: 12px;">ðŸ“Ž attachment.pdf</div>';
      } else {
        attachmentsContainer.innerHTML = '';
      }
    };

    // Submit button functionality
    document.getElementById('submit-button').addEventListener('click', () => {
      const message = textarea.value.trim();
      if (message) {
        helpModal.logEvent(`Message sent: "${message}"`);
        // Clear textarea
        textarea.value = '';
        autoGrowTextarea();
      }
    });
  </script>
</body>
</html>
