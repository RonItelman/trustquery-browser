<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrustQuery - Interactive Textarea Demo</title>
  <link rel="icon" type="image/svg+xml" href="./assets/trustquery-logo.svg">
  <link rel="stylesheet" href="./demo.css">
  <link rel="stylesheet" href="./modal.css">
</head>
<body>

  <header style="display: flex; align-items: center;">
    <div id="logo-container" style="display: flex; align-items: center; gap: 12px;">
      <img src="./assets/trustquery-logo.svg" alt="TrustQuery Logo" style="height: 32px; width: auto;">
      <span style="font-weight: bold; font-size: 20px;">TrustQuery</span>
    </div>
    <button id="help-button" class="help-button" title="Open Help">
      <span class="material-icons-outlined">help_outline</span>
    </button>
  </header>

  <div id="chat-messages" class="chat-messages">
    <!-- Chat messages will appear here -->
  </div>

  <div id="chat-input-wrapper" class="chat-input-wrapper">
    <div id="chat-attachments-container" class="chat-attachments-container">
      <!-- Attachments will appear here -->
    </div>

    <div class="chat-input-content">
      <div id="chat-input-container" class="chat-input-container">
        <textarea id="demo-textarea" placeholder="Type your message... Try @analytics, @client, or temporal words like 'yesterday'" rows="1"></textarea>
      </div>

      <div class="chat-actions-row">
        <div id="chat-input-submit" class="chat-input-submit">
          <button id="submit-button" class="submit-button" title="Send message">
            <span class="material-icons-outlined">send</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import TrustQuery from '../dist/trustquery.js';
    import HelpModalManager from './HelpModalManager.js';
    import AttachmentManager from './AttachmentManager.js';
    import AttachmentStyleManager from './AttachmentStyleManager.js';

    console.log('[Demo] Initializing TrustQuery...');

    // Initialize Help Modal Manager
    const helpModal = new HelpModalManager(null); // Pass null initially, update after editor loads

    // Initialize TrustQuery with new API
    const editor = TrustQuery.init('demo-textarea', {
      // Trigger map configuration
      triggerMap: {
        source: 'url',
        url: './tql-triggers.json'
      },

      // Built-in features
      features: {
        autoGrow: true,
        maxHeight: 300,
        debug: false
      },

      // UI settings
      ui: {
        bubbleDelay: 300,
        dropdownOffset: 28
      },

      // Event hooks (optional - for help modal logging)
      events: {
        onWordHover: (matchData) => {
          const messageState = matchData.intent?.handler?.['message-state'] || 'unknown';
          helpModal.logEvent(`Hovered: "${matchData.text}" (${messageState})`);
        },

        onWordClick: (matchData) => {
          const messageState = matchData.intent?.handler?.['message-state'] || 'unknown';
          helpModal.logEvent(`Clicked: "${matchData.text}" (${messageState})`);
          if (matchData.selectedOption) {
            const label = typeof matchData.selectedOption === 'string'
              ? matchData.selectedOption
              : matchData.selectedOption.label;
            helpModal.logEvent(`  → Selected: ${label}`);
          }
        }
      }
    });

    // Update help modal with editor reference
    helpModal.editor = editor;

    // Store globally for debugging under trustquery namespace
    window.trustquery = window.trustquery || {};
    window.trustquery.editor = editor;
    window.trustquery.helpModal = helpModal;

    // Setup help button
    document.getElementById('help-button').addEventListener('click', () => {
      helpModal.show();
    });

    // Log initialization after trigger map loads
    setTimeout(() => {
      if (editor && editor.commandMap) {
        // Count triggers from tql-triggers format
        let triggerCount = 0;
        if (editor.commandMap['tql-triggers']) {
          const triggers = editor.commandMap['tql-triggers'];
          Object.keys(triggers).forEach(state => {
            if (!state.startsWith('$') && Array.isArray(triggers[state])) {
              triggerCount += triggers[state].length;
            }
          });
        }

        helpModal.logEvent(`TrustQuery initialized with ${triggerCount} triggers`);
        // Modal content will be populated when user opens the modal
      } else {
        helpModal.logEvent('ERROR: Trigger map failed to load');
      }
    }, 1000);

    console.log('[Demo] TrustQuery initialized:', editor);

    // Initialize Attachment Managers
    const attachmentStyleManager = new AttachmentStyleManager();
    const attachmentManager = new AttachmentManager({
      container: document.getElementById('chat-attachments-container'),
      dropZone: document.getElementById('chat-input-wrapper'),
      styleManager: attachmentStyleManager,
      commandScanner: editor.scanner, // Pass scanner to check CSV columns
      dropdownManager: editor.interactionHandler?.dropdownManager, // Pass dropdown manager
      onAttachmentAdd: (data) => {
        const matchInfo = data.matches && data.matches.length > 0
          ? ` ⚠️ ${data.matches.length} column warning(s)`
          : '';
        helpModal.logEvent(`Attached: ${data.file.name} (${data.metadata.rows} rows, ${data.metadata.columns} cols)${matchInfo}`);
      },
      onAttachmentRemove: (data) => {
        helpModal.logEvent(`Removed: ${data.file.name}`);
      },
      debug: true
    });

    attachmentManager.init();

    // Expose for debugging
    window.trustquery.attachmentManager = attachmentManager;

    // Submit button functionality
    const textarea = document.getElementById('demo-textarea');
    document.getElementById('submit-button').addEventListener('click', () => {
      const message = textarea.value.trim();
      if (message) {
        helpModal.logEvent(`Message sent: "${message}"`);
        // Clear textarea (AutoGrow will handle height adjustment automatically)
        textarea.value = '';
        // Trigger input event to let AutoGrow adjust height
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
      }
    });
  </script>
</body>
</html>
